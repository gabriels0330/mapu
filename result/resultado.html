<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../imgs/favicon/favicon.ico" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Iceland&family=Jersey+10&display=swap" rel="stylesheet">

<title>Mapu | Resultado Final</title>

<style>
/* ====== PALETA PADR√ÉO ====== */
:root {
    --bg-color: #f5f3e7;
    --text-color: #1B2A41;
    --primary-color: #0B5D52;
    --highlight-color: #41E18E;
}

/* ====== PALETA COMPETITIVA (DARK) ====== */
body.competitive-mode {
    --bg-color: #121212;
    --text-color: #ffffff;
    --primary-color: #8B0000;
    --highlight-color: #FFD700;
}

body {
    margin: 0;
    padding: 0;
    background: var(--bg-color);
    font-family: 'Trebuchet MS', sans-serif;
    overflow: hidden;
    color: var(--text-color);
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: background 0.5s;
}

/* ====== LAYOUT ====== */
.end-screen {
    text-align: center;
    padding: 40px 20px;
    position: relative;
    z-index: 5;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 30px;
    backdrop-filter: blur(10px);
    box-shadow: 0 0 30px rgba(0,0,0, 0.1);
    border: 1px solid rgba(255,255,255,0.2);
    max-width: 600px;
    width: 90%;
}

body:not(.competitive-mode) .end-screen {
    background: rgba(245, 243, 231, 0.8);
    box-shadow: 0 0 30px rgba(11, 93, 82, 0.1);
}

.end-title {
    font-size: 60px;
    font-family: "Jersey 10", sans-serif;
    margin: 0 0 15px 0;
    color: var(--primary-color);
    text-shadow: 0 0 20px var(--highlight-color);
}

.stars { margin: 25px 0; min-height: 80px; }
.star { font-size: 75px; opacity: 0.2; color: #FFD700; display: inline-block; transition: 0.4s; }
.star.active { opacity: 1; transform: scale(1.2); text-shadow: 0 0 25px #FFD700; }

.feedback-info { font-size: 28px; font-weight: bold; margin-top: 20px; }

/* ESTAT√çSTICAS ESPEC√çFICAS DO COMPETITIVO */
.competitive-stats {
    display: none; /* S√≥ aparece no competitivo */
    background: rgba(0,0,0,0.3);
    padding: 15px;
    border-radius: 15px;
    margin-top: 20px;
    font-size: 18px;
    color: #ddd;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    margin: 5px 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding-bottom: 5px;
}

.stat-val-bad { color: #ff4500; font-weight: bold; }
.stat-val-good { color: #41E18E; font-weight: bold; }

.feedback {
    font-size: 22px; margin-top: 15px; font-weight: bold;
    color: var(--primary-color); min-height: 30px; text-transform: uppercase;
}

.button-row { margin-top: 35px; display: flex; justify-content: center; gap: 20px; }
.btn {
    padding: 15px 32px; border: none; border-radius: 18px; font-size: 18px;
    cursor: pointer; font-weight: bold; color: white;
    background: var(--primary-color); text-transform: uppercase;
}
.btn.secondary { background: #1B2A41; }
body.competitive-mode .btn.secondary { background: #333; }

</style>
</head>
<body>

<div class="end-screen">
    <h1 class="end-title" id="endTitle">Desafio Conclu√≠do!</h1>

    <div class="stars" id="starsContainer">
        <span class="star" id="s1">‚òÖ</span>
        <span class="star" id="s2">‚òÖ</span>
        <span class="star" id="s3">‚òÖ</span>
    </div>

    <div class="feedback-info" id="mainStats">
        Acertos: <span id="correctCount">0</span> / 10
    </div>
    
    <div class="competitive-stats" id="compStats">
        <div class="stat-item">
            <span>N√£o Respondidas (Tempo):</span>
            <span id="timeoutVal" class="stat-val-bad">0</span>
        </div>
        <div class="stat-item">
            <span>Respondidas (Intera√ß√£o):</span>
            <span id="realAnsweredVal">0</span>
        </div>
    </div>

    <p class="feedback" id="feedbackMsg"></p>

    <div class="button-row">
        <button class="btn" onclick="retry()">Jogar Novamente</button>
        <button class="btn secondary" onclick="menu()">Menu Principal</button>
    </div>
</div>

<script>
/* ================= L√ìGICA DE RESULTADOS ================= */
document.addEventListener('DOMContentLoaded', () => {
    const gameMode = localStorage.getItem('gameMode') || 'classico';
    const score = parseInt(localStorage.getItem('correctCount')) || 0;
    
    // Recupera contagem de Timeouts (que voc√™ adicionou no JS)
    const timeouts = parseInt(localStorage.getItem('quiz_timeouts')) || 0;
    
    // Define fixo como 10 (regra do jogo)
    const totalQuestions = 10; 

    setupUI(gameMode, score, timeouts, totalQuestions);
});

function setupUI(mode, score, timeouts, totalFixed) {
    const title = document.getElementById("endTitle");
    const mainStats = document.getElementById("mainStats");
    const compStats = document.getElementById("compStats");
    const starsContainer = document.getElementById("starsContainer");
    
    // --- MODO COMPETITIVO ---
    if (mode === 'competitivo') {
        document.body.classList.add('competitive-mode');
        title.textContent = "SESS√ÉO FINALIZADA";
        starsContainer.style.display = 'block'; 
        
        mainStats.innerHTML = `Acertos: <span style="color:#41E18E">${score}</span> <span style="font-size:0.7em; color:#888;">/ ${totalFixed}</span>`;
        compStats.style.display = 'block'; // Mostra o painel detalhado
        
        // --- A L√ìGICA DE SUBTRA√á√ÉO QUE VOC√ä PEDIU ---
        // Se o total √© 10 e tivemos X timeouts:
        // Respondidas pelo usu√°rio = 10 - Timeouts
        const actuallyAnswered = totalFixed - timeouts;

        document.getElementById("timeoutVal").textContent = timeouts; // Quantas n√£o respondeu
        document.getElementById("realAnsweredVal").textContent = actuallyAnswered; // Quantas tentou

        calculateStarsAndFeedback(score, totalFixed, 'competitivo'); 
    } 
    
    // --- MODO APRENDIZADO ---
    else if (mode === 'aprendizado') {
        document.body.classList.remove('competitive-mode');
        title.textContent = "ESTUDO CONCLU√çDO";
        starsContainer.style.display = 'none'; 
        document.getElementById("correctCount").textContent = score;
        setFeedbackText(score, totalFixed, 'aprendizado');
    } 
    
    // --- MODO CL√ÅSSICO ---
    else {
        document.body.classList.remove('competitive-mode');
        title.textContent = "DESAFIO CONCLU√çDO";
        document.getElementById("correctCount").textContent = score;
        calculateStarsAndFeedback(score, totalFixed, 'classico');
    }
}

function calculateStarsAndFeedback(score, total, modeType) {
    const msg = document.getElementById("feedbackMsg");
    let percent = total > 0 ? score / total : 0;
    let stars = 0;

    if (percent === 1) stars = 3;        
    else if (percent >= 0.6) stars = 2; 
    else if (percent >= 0.3) stars = 1; 

    // Anima√ß√£o Estrelas
    for (let i = 1; i <= stars; i++) {
        setTimeout(() => {
            const s = document.getElementById("s" + i);
            if(s) s.classList.add("active");
        }, i * 400);
    }

    if (modeType === 'competitivo') {
        if (stars === 3) { msg.textContent = "üèÜ RANK: DIAMANTE"; msg.style.color = "#FFD700"; }
        else if (stars === 2) msg.textContent = "ü•á RANK: OURO";
        else if (stars === 1) msg.textContent = "ü•à RANK: PRATA";
        else msg.textContent = "ü•â RANK: BRONZE";
    } else {
        if (stars === 3) msg.textContent = "üî• √âPICO!";
        else if (stars === 2) msg.textContent = "‚ö° Muito bom!";
        else if (stars === 1) msg.textContent = "üí™ Continue!";
        else msg.textContent = "üéØ Tente de novo!";
    }
}

function setFeedbackText(score, total, mode) {
    const msg = document.getElementById("feedbackMsg");
    if (score === total) msg.textContent = "Excelente! Dominou tudo.";
    else if (score >= total/2) msg.textContent = "Bom trabalho de revis√£o.";
    else msg.textContent = "Continue estudando!";
}

function retry() { 
    // Limpa TUDO para garantir nova contagem correta
    localStorage.removeItem('correctCount');
    localStorage.removeItem('totalAnswered');
    localStorage.removeItem('quiz_timeouts'); // Limpa os timeouts
    localStorage.removeItem('quiz_ordem_v3'); 
    localStorage.removeItem('answeredIds');
    
    const prefix = localStorage.getItem('lastTopicPrefix');
    if (prefix) window.location.href = `../questions_${prefix}/${prefix}_q_1.html`;
    else window.location.href = '../topico.html';
}

function menu() { 
    localStorage.removeItem('quiz_ordem_v3');
    window.location.href = '../topico.html'; 
}

// Bloqueio de Voltar
history.pushState(null, null, location.href);
window.addEventListener('popstate', () => {
    if(confirm("Sair do jogo?")) window.location.replace('../topico.html');
    else history.pushState(null, null, location.href);
});
</script>
</body>
</html>